pkgname=Pacman.NET
pkgver=0
pkgrel=1
pkgdesc='Arch Linux package cache and repository'
arch=('x86_64' 'arm' 'armv6h' 'armv7h' 'aarch64')
url="https://github.com/ricardoalcaraz/Pacman.NET"
source=("${pkgname}"::"git+https://github.com/ricardoalcaraz/Pacman.NET.git")
depends=('dotnet-runtime' 'aspnet-runtime')
b2sums=('SKIP')
backup=('etc/pacman.d/mirrorlist')

build() {
  cd $srcdir/$pkgname/$pkgname
  dotnet publish -o $srcdir/publish/$pkgname
}

check() {
  cd $srcdir/$pkgname
  #dotnet test
}

package() {
  mkdir -p $pkgdir/usr/lib/sysusers.d
  echo 'u pacnet 1420 "Pacman.NET dedicated user"' > "$pkgdir/usr/lib/sysusers.d/$pkgname.conf"
  echo 'm pacnet http -' >> "$pkgdir/usr/lib/sysusers.d/$pkgname.conf"
  cd $srcdir/publish/
  mkdir -p $pkgdir/srv/http
  mv $pkgname $pkgdir/srv/http/$pkgname
  chown -R 1420:http $pkgdir/srv/http/$pkgname
  chmod 775 -R $pkgdir/srv/http/$pkgname
    #create symbolic link back to original
    #mv /etc/pacman.d/mirrorlist > /srv/Pacman.NET/mirrorlist
    #ln -s /srv/Pacman.NET/mirrorlist /etc/pacman.d/mirrorlist
    #chown root:root /etc/pacman.d/mirrorlist
    #chmod 444 /etc/package.d/mirrorlist
  install -Dm644  $srcdir/$pkgname/$pkgname/deploy/$pkgname.service $pkgdir/usr/lib/systemd/system/$pkgname.service

}